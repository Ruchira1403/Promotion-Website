pipeline {
    agent any
    
    environment {
        ANSIBLE_DIR = 'ansible'
        EC2_IP = '13.218.143.183'  // Use your actual EC2 IP here
        WSL_SSH_KEY = '/home/myuser/.ssh/Promotion-Website.pem'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/udaraDev/Promotion-Website.git'
            }
        }
        
        stage('Troubleshoot Connection') {
            steps {
                script {
                    bat '''
                        wsl ping -c 4 13.218.143.183
                        wsl nmap -p 22 13.218.143.183 || echo "Nmap not installed or port 22 closed"
                        wsl cat /home/myuser/.ssh/Promotion-Website.pem | head -5 || echo "Cannot read key file"
                    '''
                }
            }
        }
        
        stage('Prepare SSH Key') {
            steps {
                script {
                    // Create directories if they don't exist
                    bat '''
                        if not exist ansible mkdir ansible
                        wsl mkdir -p /home/myuser/.ssh
                    '''
                    
                    // Set proper permissions on existing key
                    bat '''
                        wsl chmod 600 /home/myuser/.ssh/Promotion-Website.pem
                        wsl ls -la /home/myuser/.ssh/Promotion-Website.pem
                    '''
                    
                    // Test SSH connection with retry and longer timeout
                    retry(3) {
                        bat '''
                            wsl ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i /home/myuser/.ssh/Promotion-Website.pem ubuntu@13.218.143.183 "echo SSH connection successful"
                        '''
                    }
                }
            }
        }
        
        stage('Test Ansible Deployment') {
            steps {
                dir(ANSIBLE_DIR) {
                    script {
                        // Verify EC2_IP is set
                        if (!env.EC2_IP?.trim()) {
                            error "EC2 IP address not set. Cannot proceed with deployment."
                        }
                        
                        withCredentials([
                            usernamePassword(credentialsId: 'dockerhub-cred',
                                         usernameVariable: 'DOCKER_HUB_USERNAME',
                                         passwordVariable: 'DOCKER_HUB_PASSWORD')
                        ]) {
                            def gitCommitHash = bat(script: 'wsl git rev-parse --short HEAD', returnStdout: true).trim().readLines().last()
                            
                            // Create inventory file with improved timeout settings
                            writeFile file: 'temp_inventory.ini', text: """[ec2]
${env.EC2_IP} ansible_user=ubuntu ansible_ssh_private_key_file=${env.WSL_SSH_KEY}

[ec2:vars]
ansible_python_interpreter=/usr/bin/python3
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=30'
"""
                            // Run Ansible playbook with retry
                            retry(2) {
                                def result = bat(
                                    script: "wsl ansible-playbook -i temp_inventory.ini deploy.yml -u ubuntu --private-key ${env.WSL_SSH_KEY} -e \"DOCKER_HUB_USERNAME=tharuka2001 GIT_COMMIT_HASH=${gitCommitHash}\" -vvv",
                                    returnStatus: true
                                )
                                
                                if (result != 0) {
                                    error "Ansible deployment failed with exit code ${result}"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'Ansible deployment test completed successfully!'
            echo "Frontend URL: http://${env.EC2_IP}:5173"
            echo "Backend URL: http://${env.EC2_IP}:4000"
        }
        failure {
            echo 'Ansible deployment test failed!'
            echo 'Please check the following:'
            echo '1. EC2 instance status (running/stopped)'
            echo '2. Security group allows SSH (port 22) from Jenkins server'
            echo '3. EC2 IP address is correct and up-to-date'
            echo '4. SSH key is valid and has correct permissions'
        }
    }
}